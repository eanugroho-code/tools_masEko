<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konversi PDF/HEIC/WebP ‚Üí JPG</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; }
        body { background:linear-gradient(135deg,#6a11cb 0%,#2575fc 100%); color:#333; min-height:100vh; padding:20px; }
        .container { max-width:800px; margin:0 auto; background:white; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.2); overflow:hidden; }
        header { background:linear-gradient(to right,#2575fc,#6a11cb); color:white; padding:25px 20px; text-align:center; }
        h1 { font-size:2rem; margin-bottom:10px; }
        .subtitle { font-size:1rem; opacity:0.9; margin:0 auto; }
        .main-content { padding:30px; }
        .upload-section { margin-bottom:20px; }
        .upload-area { border:2px dashed #6a11cb; border-radius:10px; padding:40px 20px; text-align:center; cursor:pointer; transition:all .3s; margin-bottom:20px; }
        .upload-area:hover { background:#f9f7ff; border-color:#2575fc; }
        .upload-icon { font-size:50px; color:#6a11cb; margin-bottom:15px; }
        .file-input { display:none; }
        .controls { margin-top:20px; }
        .control-group { margin-bottom:15px; }
        label { display:block; margin-bottom:8px; font-weight:600; color:#444; }
        .slider-container { display:flex; align-items:center; }
        .slider { flex:1; height:8px; -webkit-appearance:none; background:#e0e0e0; border-radius:5px; outline:none; }
        .slider::-webkit-slider-thumb { -webkit-appearance:none; width:20px; height:20px; border-radius:50%; background:#6a11cb; cursor:pointer; }
        .slider-value { margin-left:15px; font-weight:600; color:#6a11cb; min-width:40px; }
        .format-options { display:flex; gap:10px; margin-top:10px; }
        .format-option { flex:1; padding:12px; text-align:center; border:2px solid #e0e0e0; border-radius:8px; cursor:pointer; transition:all .3s; }
        .format-option.active { border-color:#6a11cb; background:#f0f4ff; color:#6a11cb; font-weight:600; }
        .btn { display:block; width:100%; padding:14px; background:linear-gradient(to right,#2575fc,#6a11cb); color:white; border:none; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; transition:all .3s; margin-top:10px; }
        .btn:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,0.1); }
        .btn:disabled { background:#ccc; cursor:not-allowed; }
        .progress-container { margin-top:20px; display:none; }
        .progress-bar { width:100%; height:20px; background:#e0e0e0; border-radius:10px; overflow:hidden; margin-bottom:10px; }
        .progress-fill { height:100%; background:linear-gradient(to right,#2575fc,#6a11cb); width:0%; transition:width .3s; }
        .progress-text { text-align:center; font-weight:600; color:#444; }
        .file-list-container { margin-top:15px; max-height:200px; overflow-y:auto; border:1px solid #e0e0e0; border-radius:5px; padding:10px; background:white; }
        .file-item { padding:5px 0; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center; }
        .remove-file { background:#ff4d4d; color:white; border:none; border-radius:50%; width:20px; height:20px; cursor:pointer; font-size:12px; }
        .result-section { margin-top:20px; display:none; }
        .success-message { background:#d4edda; color:#155724; padding:15px; border-radius:8px; margin-bottom:15px; text-align:center; }
        .download-all-btn { padding:12px 25px; background:linear-gradient(to right,#2575fc,#6a11cb); color:white; border:none; border-radius:5px; font-weight:600; cursor:pointer; width:100%; }
        .file-info { margin-top:15px; background:#f8f9fa; padding:15px; border-radius:8px; }
        .info-row { display:flex; justify-content:space-between; margin-bottom:8px; }
        footer { text-align:center; padding:20px; background:#f8f9fa; color:#666; font-size:0.9rem; }
    </style>
    <!-- Library PDF.js & HEIC2ANY -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
</head>
<body>
<div class="container">
    <header>
        <h1>Konversi PDF/HEIC/WebP ‚Üí JPG</h1>
        <p class="subtitle">Konversi file Anda dengan mudah ke format JPG atau PNG</p>
    </header>

    <div class="main-content">
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <h3>Seret & Jatuhkan File di Sini</h3>
                <p>Support: PDF, HEIC, WebP, dan gambar lainnya (maksimal 8 file)</p>
                <button class="btn" id="browseBtn">Pilih File</button>
                <input type="file" id="fileInput" class="file-input" accept="image/*,application/pdf,.heic,.heif" multiple>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label for="qualitySlider">Kualitas JPG (%)</label>
                    <div class="slider-container">
                        <input type="range" id="qualitySlider" class="slider" min="10" max="100" value="90">
                        <span id="qualityValue" class="slider-value">90%</span>
                    </div>
                </div>
                <div class="control-group">
                    <label>Format Output</label>
                    <div class="format-options">
                        <div class="format-option active" data-format="jpeg">JPG</div>
                        <div class="format-option" data-format="png">PNG</div>
                    </div>
                </div>
                <button class="btn" id="convertBtn" disabled>Konversi Semua File</button>
            </div>
            <div class="file-list-section">
                <h3>Daftar File</h3>
                <div class="file-list-container" id="fileListContainer">
                    <p>Belum ada file yang dipilih</p>
                </div>
            </div>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Memproses: 0%</div>
        </div>

        <div class="file-info" id="fileInfo" style="display:none;">
            <div class="info-row">
                <span class="info-label">Total File:</span>
                <span id="totalFiles" class="info-value">0</span>
            </div>
            <div class="info-row">
                <span class="info-label">Diproses:</span>
                <span id="processedFiles" class="info-value">0</span>
            </div>
        </div>

        <div class="result-section" id="resultSection">
            <div class="success-message">Konversi Selesai!</div>
            <button class="download-all-btn" id="downloadBtn">Unduh Semua File</button>
        </div>
    </div>

    <footer>
        <p>¬© 2025 - Konversi PDF/HEIC/WebP ‚Üí JPG</p>
    </footer>
</div>

<script>
// Elemen DOM
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const browseBtn = document.getElementById('browseBtn');
const convertBtn = document.getElementById('convertBtn');
const qualitySlider = document.getElementById('qualitySlider');
const qualityValue = document.getElementById('qualityValue');
const formatOptions = document.querySelectorAll('.format-option');
const fileListContainer = document.getElementById('fileListContainer');
const progressContainer = document.getElementById('progressContainer');
const progressFill = document.getElementById('progressFill');
const progressText = document.getElementById('progressText');
const fileInfo = document.getElementById('fileInfo');
const totalFiles = document.getElementById('totalFiles');
const processedFiles = document.getElementById('processedFiles');
const resultSection = document.getElementById('resultSection');
const downloadBtn = document.getElementById('downloadBtn');

// Variabel
let files = [];
let convertedBlobs = [];
let outputFormat = 'jpeg';

// Event Listeners
browseBtn.onclick = () => fileInput.click();
uploadArea.onclick = () => fileInput.click();

uploadArea.ondragover = (e) => {
    e.preventDefault();
    uploadArea.style.backgroundColor = '#f0f0ff';
};

uploadArea.ondragleave = () => {
    uploadArea.style.backgroundColor = '';
};

uploadArea.ondrop = (e) => {
    e.preventDefault();
    uploadArea.style.backgroundColor = '';
    handleFiles(e.dataTransfer.files);
};

fileInput.onchange = (e) => handleFiles(e.target.files);
qualitySlider.oninput = () => qualityValue.textContent = qualitySlider.value + '%';

formatOptions.forEach(option => {
    option.onclick = () => {
        formatOptions.forEach(x => x.classList.remove('active'));
        option.classList.add('active');
        outputFormat = option.dataset.format;
    };
});

convertBtn.onclick = startConversion;
downloadBtn.onclick = downloadConverted;

// Fungsi Utilitas
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
}

// Handle File Selection
function handleFiles(fileList) {
    const arr = Array.from(fileList);
    
    if (files.length + arr.length > 8) {
        alert('Maksimal 8 file sekaligus!');
        arr.splice(0, arr.length - (8 - files.length));
    }
    
    files.push(...arr);
    updateFileList();
    totalFiles.textContent = files.length;
    convertBtn.disabled = files.length === 0;
    fileInfo.style.display = 'block';
}

function updateFileList() {
    fileListContainer.innerHTML = '';
    
    if (files.length === 0) {
        fileListContainer.innerHTML = '<p>Belum ada file yang dipilih</p>';
        return;
    }
    
    files.forEach((file, index) => {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.innerHTML = `
            <div class="file-name">${file.name}</div>
            <div class="file-size">${formatFileSize(file.size)}</div>
            <button class="remove-file" data-index="${index}">√ó</button>
        `;
        fileListContainer.appendChild(div);
    });
    
    document.querySelectorAll('.remove-file').forEach(button => {
        button.onclick = function() {
            const index = parseInt(this.dataset.index);
            files.splice(index, 1);
            updateFileList();
            totalFiles.textContent = files.length;
            convertBtn.disabled = files.length === 0;
            
            if (files.length === 0) {
                fileInfo.style.display = 'none';
            }
        };
    });
}

// Konversi File
async function startConversion() {
    if (!files.length) return;
    
    progressContainer.style.display = 'block';
    resultSection.style.display = 'none';
    convertedBlobs = [];
    
    let processed = 0;
    
    for (const file of files) {
        try {
            const results = await convertFile(file);
            convertedBlobs.push(...results);
        } catch (error) {
            console.error('Error converting file:', error);
            convertedBlobs.push({
                blob: file,
                name: file.name
            });
        }
        
        processed++;
        processedFiles.textContent = processed;
        
        const progress = (processed / files.length) * 100;
        progressFill.style.width = progress + '%';
        progressText.textContent = `Memproses: ${Math.round(progress)}%`;
    }
    
    progressContainer.style.display = 'none';
    resultSection.style.display = 'block';
}

async function convertFile(file) {
    const quality = qualitySlider.value / 100;
    const mime = outputFormat === 'jpeg' ? 'image/jpeg' : 'image/png';
    const ext = outputFormat === 'jpeg' ? 'jpg' : 'png';
    
    // Konversi PDF
    if (file.type === 'application/pdf') {
        const arr = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arr }).promise;
        const results = [];
        
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 2 });
            
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            await page.render({
                canvasContext: canvas.getContext('2d'),
                viewport: viewport
            }).promise;
            
            const blob = await new Promise(resolve => {
                canvas.toBlob(resolve, mime, outputFormat === 'jpeg' ? quality : 1);
            });
            
            const name = file.name.replace(/\.pdf$/i, '') + `_halaman_${i}.${ext}`;
            results.push({ blob, name });
        }
        
        return results;
    }
    
    // Konversi HEIC/HEIF
    if (file.type === 'image/heic' || file.type === 'image/heif' || /\.(heic|heif)$/i.test(file.name)) {
        const converted = await heic2any({
            blob: file,
            toType: mime,
            quality: quality
        });
        
        const blob = Array.isArray(converted) ? converted[0] : converted;
        const name = file.name.replace(/\.(heic|heif)$/i, '') + '.' + ext;
        
        return [{ blob, name }];
    }
    
    // Konversi gambar biasa (WebP, PNG, JPG, dll)
    const img = new Image();
    const url = URL.createObjectURL(file);
    
    await new Promise((resolve, reject) => {
        img.onload = resolve;
        img.onerror = reject;
        img.src = url;
    });
    
    const canvas = document.createElement('canvas');
    canvas.width = img.width;
    canvas.height = img.height;
    
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0);
    
    const blob = await new Promise(resolve => {
        canvas.toBlob(resolve, mime, outputFormat === 'jpeg' ? quality : 1);
    });
    
    URL.revokeObjectURL(url);
    
    let name = file.name.split('.').slice(0, -1).join('.');
    if (!name) name = 'gambar';
    name += '.' + ext;
    
    return [{ blob, name }];
}

// Download Hasil
function downloadConverted() {
    if (!convertedBlobs.length) {
        alert('Belum ada hasil konversi.');
        return;
    }
    
    convertedBlobs.forEach(item => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(item.blob);
        a.download = item.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    });
}
</script>
</body>
</html>
